<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.infosmart.mapper.ReportMapper">

	<resultMap type="ReportDesign" id="ReportResultMap">
		<id column="report_id" property="reportId" />
		<result column="report_name" property="reportName" />
		<result column="report_sql" property="reportSql" />
		<result column="report_define" property="reportDefine" />
		<result column="data_source_id" property="dataSourceId" />
		<result column="parent_id" property="parentId" />
		<result column="is_report" property="isReport" />
		<result column="remark" property="remark" />
		<result column="500W_RPT_FLAG" property="rptFlag500w" />
		<result column="500W_RPT_URL" property="rptUrl500w" />
	</resultMap>

	<!-- report_and_child_report -->
	<resultMap type="ReportDesign" id="ReportAndChildReport">
		<id column="report_id" property="reportId" />
		<result column="report_name" property="reportName" />
		<result column="parent_id" property="parentId" />
		<result column="is_report" property="isReport" />
		<result column="500W_RPT_FLAG" property="rptFlag500w" />
		<result column="500W_RPT_URL" property="rptUrl500w" />
		<collection property="subReportList" resultMap="childReport"
			javaType="java.util.ArrayList" column="repord_id">
		</collection>
	</resultMap>
	<!-- child_report -->
	<resultMap type="ReportDesign" id="childReport">
		<id column="s_report_id" property="reportId" />
		<result column="s_report_name" property="reportName" />
		<result column="s_parent_id" property="parentId" />
		<result column="s_is_report" property="isReport" />
		<result column="s_500W_RPT_FLAG" property="rptFlag500w" />
		<result column="s_500W_RPT_URL" property="rptUrl500w" />
	</resultMap>

	<!-- 维度从表 -->
	<resultMap id="DimensionDetailMap" type="DimensionDetail">
		<result property="primaryKeyId" column="ID" />
		<result property="dimensionId" column="DIMENSION_ID" />
		<result property="key" column="KEY_OF_VALUE" />
		<result property="value" column="VALUE_OF_KEY" />
	</resultMap>
	<!-- 查询报表  infosmart 20120604 -->
	<select id="queryReportById" parameterType="String" resultMap="ReportResultMap">
		select * from tb_rpt_design where report_id=#{reportId}
	</select>
	<!-- 查询从表信息 infosmart 20120605 -->
	<select id="queryConfigById" parameterType="String"
		resultMap="ReportConfigResultMap">
		select * from tb_rpt_report_config where report_id=#{reportId}
		ORDER BY COLUMN_SORT
	</select>

	<!-- 查询维度明细 -->
	<select id="listDimensionDetail" parameterType="int"
		resultMap="DimensionDetailMap">
		SELECT a.* FROM tb_rpt_dimension_detail a where
		a.dimension_id
		=#{dimensionId}
	</select>

	<!-- 查询所有子节点 infosmart 20120604 -->
	<select id="getChildReport" resultMap="ReportResultMap">
		select report_id from
		tb_rpt_design where report_id not in (select
		DISTINCT(parent_id) from tb_rpt_design
		where parent_id is not null)
	</select>

	<!-- 查询所有表结构  infosmart 20120604-->
	<select id="listAllParentReport" resultMap="ReportAndChildReport">
		select
		f.report_id,f.report_name,f.parent_id,f.is_report,
        f.500W_RPT_FLAG,
        f.500W_RPT_URL,
		s.report_id as
		s_report_id,s.report_name as s_report_name,s.parent_id as
		s_parent_id,s.is_report as s_is_report,
		s.500W_RPT_FLAG AS s_500W_RPT_FLAG,
        s.500W_RPT_URL AS s_500W_RPT_URL
		from tb_rpt_design f left JOIN tb_rpt_design
		s
		on
		f.report_id=s.parent_id
		where
		f.parent_id is null
	</select>
	
	<!-- 查询所有报表(包含一级和二级的) date 2012-06-04 infosmart-->
	<select id="listAllReport"  resultMap="ReportResultMap">
		select report_id,report_name,parent_id,is_report,remark,500W_RPT_FLAG AS 500W_RPT_FLAG,500W_RPT_URL AS s_500W_RPT_URL
		from tb_rpt_design 
	</select>
	
	<!-- 查询所一二级报表(添加报表用) date 2012-06-04 infosmart -->
	<select id="listAllToAdd" resultMap="ReportResultMap">
		SELECT r.report_id,IF(length(IFNULL(sr.report_name, ''))= 0,
			r.report_name,CONCAT(sr.report_name,' / ',r.report_name))AS report_name,
		 r.parent_id,r.is_report,r.500W_RPT_FLAG
		FROM tb_rpt_design r
		LEFT JOIN(
			SELECT report_id,report_name
			FROM tb_rpt_design
			WHERE is_report = 0 )sr ON r.parent_id = sr.report_id
		WHERE r.is_report = 0 ORDER BY r.report_id
	</select>
	
	<!-- date 2012-06-04 infosmart -->
	<select id="listSubReportByParentId" parameterType="int" resultMap="ReportAndChildReport">
		select f.report_id,f.report_name,f.parent_id,f.is_report,
		f.500W_RPT_FLAG,
        f.500W_RPT_URL,
		s.report_id as s_report_id,
		s.report_name as s_report_name,
		s.parent_id as s_parent_id ,
		s.is_report as s_is_report ,
		s.500W_RPT_FLAG AS s_500W_RPT_FLAG,
        s.500W_RPT_URL AS s_500W_RPT_URL
		from tb_rpt_design f left JOIN
		tb_rpt_design s on f.report_id=s.parent_id
		where f.parent_id=#{parentId}
	</select>
	
	<!-- 查询 BY id  date 2012-06-04 infosmart-->
	<select id="getReportById" parameterType="int" resultMap="ReportResultMap">
		select * from tb_rpt_design where report_id=#{reportId}
	</select>
	
	<!-- 插入表结构   date 2012-06-04 infosmart -->
	<insert id="insertReport" parameterType="ReportDesign"
		useGeneratedKeys="true" keyProperty="id">
		insert into tb_rpt_design
		(report_name,parent_id,is_report,remark)
		values
		(#{reportName},#{parentId},#{isReport},#{remark})
	</insert>
	<!-- 更新表结构   date 2012-06-04 infosmart-->
	<update id="updateReport" parameterType="ReportDesign">
		update tb_rpt_design set
		report_name=#{reportName},parent_id=#{parentId},remark=#{remark}
		where
		report_id=#{reportId}
	</update>
	<!-- 删除 date 2012-06-04 infosmart-->
	<delete id="deleteReportById" parameterType="int">
		delete from tb_rpt_design
		where report_id=#{reportId} or parent_id=#{reportId}
	</delete>
</mapper>