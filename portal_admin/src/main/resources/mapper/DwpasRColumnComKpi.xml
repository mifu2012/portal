<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="DwpasRColumnComKpiMapper">
	<resultMap id="DwpasRColumnComKpiMap" type="DwpasRColumnComKpi">
		<result property="columnId" column="COLUMN_ID" javaType="java.lang.String"
			jdbcType="VARCHAR" />
		<result property="value1" column="VALUE_1" javaType="java.lang.String"
			jdbcType="VARCHAR" />
		<result property="value2" column="VALUE_2" javaType="java.lang.String"
			jdbcType="VARCHAR" />
		<result property="value3" column="VALUE_3" javaType="java.lang.String"
			jdbcType="VARCHAR" />
		<result property="userType" column="USER_TYPE" javaType="java.lang.String"
			jdbcType="VARCHAR" />
		<result property="comKpiCode" column="com_kpi_code" javaType="java.lang.String"
			jdbcType="VARCHAR" />
		<result property="gmtCreate" column="GMT_CREATE" javaType="java.util.Date"
			jdbcType="TIMESTAMP" />
		<result property="orderNum" column="ORDER_NUM" />
	</resultMap>
	<!-- 复制指标信息 -->
	<insert id="copyDwpasRColumnComKpi" parameterType="DwpasRColumnComKpi">
		insert into
		dwpas_r_column_com_kpi
		(COLUMN_ID,
		COM_KPI_CODE,
		GMT_CREATE,
		USER_TYPE,
		VALUE_1,
		VALUE_2,
		VALUE_3)
		select CONCAT(#{newTid,jdbcType=INTEGER}, '_',
		cci.COLUMN_CODE) as
		COLUMN_ID,
		COM_KPI_CODE,
		NOW() as GMT_CREATE,
		USER_TYPE,
		VALUE_1,
		VALUE_2,
		VALUE_3
		from dwpas_r_column_com_kpi rcc,
		dwpas_c_column_info cci,
		dwpas_c_module_info cmi,
		dwpas_c_system_menu
		csm
		where rcc.COLUMN_ID = cci.COLUMN_ID
		and cci.MODULE_ID =
		cmi.MODULE_ID
		and cmi.MENU_ID = csm.MENU_ID
		and csm.TEMPLATE_ID =
		#{oldTid,jdbcType=INTEGER}
  </insert>
	<delete id="deleteDwpasRColumnComKpi" parameterType="list">
   <![CDATA[
              delete from dwpas_r_column_com_kpi  where COLUMN_ID in
        ]]>
		<foreach collection="list" item="columnId" open="(" separator=","
			close=")">
			#{columnId} 
         </foreach>
	</delete>

	<!-- 根据模块ID删除关联的通用指标 -->
	<delete id="deleteDwpasRColumnComKpiByModuleId" parameterType="java.lang.String">
		DELETE
		FROM
		dwpas_r_column_com_kpi
		WHERE
		EXISTS(
		SELECT
		cci.COLUMN_ID
		FROM
		dwpas_c_column_info cci,
		dwpas_c_module_info cmi
		WHERE
		dwpas_r_column_com_kpi.COLUMN_ID = cci.COLUMN_ID
		AND cci.MODULE_ID =
		cmi.MODULE_ID
		AND cmi.MODULE_ID =#{moduleId,jdbcType=VARCHAR}
		)
	</delete>
	<select id="getDwpasRColumnComKpiByColumnId" resultMap="DwpasRColumnComKpiMap"
		parameterType="java.lang.String">
		select
		COLUMN_ID,VALUE_1,VALUE_2,VALUE_3,USER_TYPE,com_kpi_code,GMT_CREATE
		from dwpas_r_column_com_kpi
		where COLUMN_ID =
		#{columnId,jdbcType=VARCHAR}
  </select>
	<insert id="insertCommoncode" parameterType="DwpasRColumnComKpi">
		insert into
		dwpas_r_column_com_kpi(COLUMN_ID,com_kpi_code,GMT_CREATE,USER_TYPE,value_1,value_2,value_3,order_num)
		values(#{columnId,jdbcType=VARCHAR},#{comKpiCode,jdbcType=VARCHAR},now(),#{userType,jdbcType=VARCHAR},#{value1,jdbcType=VARCHAR},#{value2,jdbcType=VARCHAR},#{value3,jdbcType=VARCHAR},#{orderNum})
	</insert>
	<delete id="deleteCommoncode" parameterType="java.lang.String">
		delete from
		dwpas_r_column_com_kpi where
		COLUMN_ID=#{columnId,jdbcType=VARCHAR}
	</delete>
</mapper>