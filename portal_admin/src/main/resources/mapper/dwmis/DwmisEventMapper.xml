<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.infosmart.mapper.dwmis.MisEventPo">

	<!-- 参数表数据 -->
	<resultMap id="MISEVENT" type="MisEventPo">
		<result property="eventId" column="EVENT_ID" />
		<result property="eventStartDate" column="EVENT_START_DATE" />
		<result property="eventEndDate" column="EVENT_ENT_DATE" />
		<result property="eventType" column="EVENT_TYPE" />
		<result property="title" column="TITLE" />
		<result property="eventTypeName" column="TYPE_NAME" />
		<result property="content" column="CONTENT" />
		<result property="isPublic" column="IS_PUBLIC" />
		<result property="createUser" column="CREATE_USER" />
		<result property="createDate" column="CREATE_DATE" />
	</resultMap>

	<resultMap id="DWMISMISTYPE" type="DwmisMisTypePo">
		<result property="typeId" column="TYPE_ID" />
		<result property="groupId" column="GROUP_ID" />
		<result property="eventType" column="EVENT_TYPE" />
		<result property="typeName" column="TYPE_NAME" />
		<result property="detail" column="DETAIL" />
	</resultMap>
	<!-- 获取所有的大事记 -->
	<select id="getALLMisEventlistPage" parameterType="MisEventPo" resultMap="MISEVENT">
		select a.EVENT_ID
		,a.EVENT_START_DATE
		,a.EVENT_ENT_DATE
		,b.TYPE_NAME
		,a.EVENT_TYPE
		,a.TITLE
		,a.CONTENT
		,a.IS_PUBLIC
		,a.CREATE_USER
		,a.CREATE_DATE
		from DWMIS_MIS_EVENT
		a
		left join dwmis_mis_type b
		on a.EVENT_TYPE = b.TYPE_ID
		<trim prefix="WHERE" prefixOverrides="AND|OR">
			<if test="title !=null and title!=''">
				a.TITLE LIKE CONCAT(CONCAT('%',#{title}),'%') 
			</if>
			<if test="eventTypeName !=null and eventTypeName!=''">
				and a.EVENT_TYPE =#{eventTypeName}
			</if>
			<!-- <if test="eventStartDate !=null and eventStartDate!=''">
				and a.EVENT_START_DATE =#{eventStartDate}
			</if>
			<if test="eventEndDate !=null and eventEndDate!=''">
				and a.EVENT_ENT_DATE =#{eventEndDate}
			</if> -->
		</trim>
		order by
		a.EVENT_START_DATE DESC
	</select>

	<!-- 添加一条大事记记录 -->
	<insert id="insertMisEvent" parameterType="BigEventPo">
		insert into
		DWMIS_MIS_EVENT(EVENT_START_DATE,EVENT_ENT_DATE,TITLE,EVENT_TYPE,CONTENT,IS_PUBLIC,CREATE_DATE)
		values(#{eventStartDate},#{eventEndDate},#{title},#{eventType},#{content},#{isPublic},now())
	</insert>

	<!-- 修改相关大事记记录 -->
	<update id="upMisEventByEnentId" parameterType="BigEventPo">
		update
		DWMIS_MIS_EVENT
		set EVENT_START_DATE=#{eventStartDate}
		,EVENT_ENT_DATE=#{eventEndDate}
		,TITLE=#{title}
		,EVENT_TYPE =
		#{eventType}
		,CONTENT=#{content}
		,IS_PUBLIC=#{isPublic}
		where
		EVENT_ID=#{eventId}
	</update>

	<!--批量删除相关大事记记录 -->
	<delete id="deleteMisEventByEnentIds" parameterType="list">
        <![CDATA[
            delete from DWMIS_MIS_EVENT where EVENT_ID in
        ]]>
		<foreach collection="list" item="ids" open="(" separator=","
			close=")">
			#{ids}
		</foreach>
	</delete>
	<!--删除相关大事记记录 -->
	<delete id="deleteMisEventByEnentId" parameterType="int">
		delete from
		DWMIS_MIS_EVENT where EVENT_ID = #{id,jdbcType=INTEGER}
	</delete>

	<!-- 根据ID获取对应的大事记记录 -->
	<select id="getMisEventById" resultMap="MISEVENT">
		select a.EVENT_ID
		,a.EVENT_START_DATE
		,a.EVENT_ENT_DATE
		,b.TYPE_NAME
		,a.EVENT_TYPE
		,a.TITLE
		,a.CONTENT
		,a.IS_PUBLIC
		,a.CREATE_USER
		,a.CREATE_DATE
		from DWMIS_MIS_EVENT
		a
		left join dwmis_mis_type b
		on a.EVENT_TYPE = b.TYPE_ID
		where a.EVENT_ID
		= #{eventId}
		order by a.EVENT_START_DATE DESC

	</select>
	<!-- 根据指标CODE获得最近最新N条大事记列表 -->
	<select id="queryNewEventsByKpiCode" resultMap="MISEVENT">
		select
		EVENT_ID,EVENT_START_DATE,EVENT_ENT_DATE,EVENT_TYPE,TITLE,CONTENT,ATTACH,IS_PUBLIC,CREATE_USER,CREATE_DATE
		from
		(
		select *
		from DWMIS_MIS_EVENT
		where EVENT_ID in(
		select EVENT_ID from DWMIS_MIS_KPI_EVENT_R
		where KPI_CODE = #{kpiCode}
		)
		order by EVENT_START_DATE DESC
		)a
		where 1 = 1

	</select>

	<!-- 获取eventId -->
	<select id="getEventId" resultMap="MISEVENT">
		select EVENT_ID as eventId
		from DWMIS_MIS_EVENT
	</select>

	<!-- 获得大事记类型列表 -->
	<select id="getEventsTypeName" resultMap="DWMISMISTYPE">
		<![CDATA[ 
		SELECT b.type_id,b.TYPE_NAME
		FROM dwmis_mis_type b
		WHERE b.TYPE_NAME != null
		OR b.TYPE_NAME != ''
		AND type_id < 8000
		AND type_id > 7000
		GROUP BY b.type_id,b.TYPE_NAME
		]]>   
	</select>
<!-- 根据ID获得大事记类型列表 -->
	<select id="getEventsTypeNameById"  resultMap="DWMISMISTYPE">	
	<![CDATA[ 
		SELECT b.type_id,b.TYPE_NAME
		FROM dwmis_mis_type b
		WHERE b.TYPE_NAME != null
		OR b.TYPE_NAME != ''
		AND type_id < 8000
		AND type_id > 7000
	]]>   
		<if test="id !=null ">
		AND	type_id != #{id}   
       	</if>
		GROUP BY b.type_id,b.TYPE_NAME
		   
	</select>
	
	<!-- 根据ID删除对应事件类型 -->
	<delete id="deleteEventTypeById">
	delete from dwmis_mis_type where type_id = #{typeId,jdbcType=INTEGER}
	</delete>
	
	<!-- 根据ID查询对应事件类型 -->
	<select id="getDwmisMisTypePoById"  resultMap="DWMISMISTYPE">
		<![CDATA[ 
		SELECT b.type_id,b.TYPE_NAME,b.group_id,b.detail
		FROM dwmis_mis_type b
		WHERE b.TYPE_NAME != null
		OR b.TYPE_NAME != ''
		AND type_id < 8000
		AND type_id > 7000
		AND type_id = #{typeId,jdbcType=INTEGER}
		GROUP BY b.type_id,b.TYPE_NAME
		]]>   
	</select>
	
	<!-- 插入一条事件类别 -->
	<insert id="insertEventType" parameterType="DWMISMISTYPE">
		insert into
		dwmis_mis_type(type_id,type_name,group_id,detail)
		values(#{typeId},#{typeName},#{groupId},#{detail})
	</insert>
	<!-- 校验类型名称是否已存在  zy -->

	<select id="checkTypeName" parameterType="java.lang.String" resultMap="DWMISMISTYPE">
	<![CDATA[
	SELECT b.TYPE_NAME
		FROM dwmis_mis_type b
		WHERE type_id < 8000
		AND type_id > 7000
		and TYPE_NAME=#{typeName}
		]]>  
	</select>
	<!-- 修改相关事件类别 -->
	<update id="updateEventType" parameterType="DWMISMISTYPE">
		update dwmis_mis_type
		set type_name=#{typeName}
		,group_id=#{groupId}
		,detail = #{detail}
		where type_id=#{typeId}
	</update>
</mapper>