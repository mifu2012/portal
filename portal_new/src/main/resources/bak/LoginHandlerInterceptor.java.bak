package com.infosmart.portal.interceptor;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.log4j.Logger;
import org.springframework.web.servlet.handler.HandlerInterceptorAdapter;

import com.infosmart.portal.pojo.User;
import com.infosmart.portal.util.Constants;
import com.infosmart.portal.util.StringUtils;
import com.infosmart.portal.util.db.CustomerContextHolder;
import com.infosmart.portal.util.db.SpObserver;

public class LoginHandlerInterceptor extends HandlerInterceptorAdapter {
	private Logger logger = Logger.getLogger(this.getClass());
	public static final String NO_INTERCEPTOR_PATH = ".*/((login)|(quit)).*";

	@Override
	public boolean preHandle(HttpServletRequest request,
			HttpServletResponse response, Object handler) throws Exception {
		this.logger.info("------->" + request.getServletPath());
		String path = request.getServletPath();
		if (path.matches(NO_INTERCEPTOR_PATH)) {
			String loginName = request.getParameter("loginName");
			/*
			 * if ("admin".equalsIgnoreCase(loginName)) {
			 * CustomerContextHolder.setDataSourceType("dataSource_500w");
			 * this.logger.info("500W用户登陆了......................."); } else {
			 * this.logger.info("其他用户登陆了.......................");
			 * CustomerContextHolder.setDataSourceType("dataSource"); }
			 */
			if ("admin".equalsIgnoreCase(loginName)) {
				SpObserver.putDbName("dataSource_500w");
				this.logger.info("500W用户登陆了.......................");
			} else {
				SpObserver.putDbName("dataSource");
				this.logger.info("其他用户登陆了.......................");
			}
			return true;
		} else {
			Object user = request.getSession().getAttribute(
					Constants.SESSION_USER_INFO);
			if (user != null) {
				User loginUser = (User) user;
				this.logger.info("当前操作用户：" + loginUser.getUserName());
				/*
				 * if ("admin".equalsIgnoreCase(loginUser.getLoginName())) {
				 * CustomerContextHolder.setDataSourceType("dataSource_500w");
				 * this.logger.info("500W用户登陆......................."); } else {
				 * this.logger.info("其他用户登陆.......................");
				 * CustomerContextHolder.setDataSourceType("dataSource"); }
				 */
				if ("admin".equalsIgnoreCase(loginUser.getLoginName())) {
					SpObserver.putDbName("dataSource_500w");
					this.logger.info("500W用户登陆.......................");
				} else {
					SpObserver.putDbName("dataSource");
					this.logger.info("其他用户登陆.......................");
				}
				return true;
			} else {
				this.logger.info("退出系统....");
				response.sendRedirect(request.getContextPath() + "/quit");
				this.logger.info("------->" + request.getContextPath());
				return false;
			}

		}

	}

}
