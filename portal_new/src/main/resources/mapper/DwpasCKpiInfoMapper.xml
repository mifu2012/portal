<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.infosmart.mapper.DwpasCKpiInfoMapper">
    <!-- 默认加上缓存 -->
    <!--  
    <cache readOnly="true"/>
    -->
    
	<sql id="common_sql">
		kpi_code,parent_code,kpi_name,disp_name,kpi_type,is_overall,is_show,show_order,is_average,is_max,is_variation,is_percent,unit,decimal_num,convert_num,convert_type,is_cal_kpi,role_formula,is_use,gmt_create
	</sql>
	<!-- 指标信息记录集 -->
	<resultMap id="DwpasCKpiInfoResultMap" type="DwpasCKpiInfo">
		<!-- WARNING - This element is automatically generated by Apache iBATIS 
			ibator, do not modify. This element was generated on Mon Feb 20 17:20:52 
			CST 2012. -->
		<result column="kpi_code" property="kpiCode" jdbcType="VARCHAR" />
		<result column="parent_code" property="parentCode" jdbcType="VARCHAR" />
		<result column="kpi_name" property="kpiName" jdbcType="VARCHAR" />
		<result column="disp_name" property="dispName" jdbcType="VARCHAR" />
		<result column="kpi_type" property="kpiType" jdbcType="CHAR" />
		<result column="is_overall" property="isOverall" jdbcType="CHAR" />
		<result column="is_show" property="isShow" jdbcType="CHAR" />
		<result column="show_order" property="showOrder" jdbcType="DECIMAL" />
		<result column="is_average" property="isAverage" jdbcType="CHAR" />
		<result column="is_max" property="isMax" jdbcType="CHAR" />
		<result column="is_variation" property="isVariation" jdbcType="CHAR" />
		<result column="is_percent" property="isPercent" jdbcType="CHAR" />
		<result column="unit" property="unit" jdbcType="VARCHAR" />
		<result column="decimal_num" property="decimalNum" jdbcType="DECIMAL" />
		<result column="convert_num" property="convertNum" jdbcType="DECIMAL" />
		<result column="convert_type" property="convertType" jdbcType="CHAR" />
		<result column="is_cal_kpi" property="isCalKpi" jdbcType="CHAR" />
		<result column="role_formula" property="roleFormula" jdbcType="VARCHAR" />
		<result column="is_use" property="isUse" jdbcType="CHAR" />
		<result column="type_name" property="parentName" jdbcType="VARCHAR" />
		<result column="GMT_CREATE" property="gmtCreate" jdbcType="TIMESTAMP"
			javaType="java.util.Date" />
		<!-- 数据为 0000-00-00 00:00:00 会报错，暂时去掉 -->
		<!-- <result column="GMT_MODIFIED" property="gmtModified" jdbcType="TIMESTAMP" 
			javaType="java.util.Date" /> -->
	</resultMap>
	<!-- 根据主键查询指标信息 -->
	<select id="queryOneByKpiCode" resultMap="DwpasCKpiInfoResultMap">
		SELECT
		<include refid="common_sql" />
		FROM dwpas_c_kpi_info
		<trim prefix="WHERE" prefixOverrides="AND|OR">
			kpi_code=#{kpiCode}
		</trim>
	</select>
	<!-- 根据多个指标查询指标信息 -->
	<select id="listKpiInfoByKpiCodes" resultMap="DwpasCKpiInfoResultMap"
		parameterType="java.util.HashMap">
		SELECT
		<include refid="common_sql" />
		FROM dwpas_c_kpi_info WHERE kpi_code IN
		<foreach collection="kpiCodeList" item="kpiCode" open="("
			close=")" separator=",">
			#{kpiCode,jdbcType=VARCHAR}
		</foreach>
		ORDER BY instr(#{codeStr},concat(',',kpi_code,','))
	</select>
	<!-- 分页查询指标信息 -->
	<select id="listKpiInfoByPagination" parameterType="DwpasCKpiInfo"
		resultMap="DwpasCKpiInfoResultMap">
		SELECT
		<include refid="common_sql" />
		FROM dwpas_c_kpi_info
		<trim prefix="WHERE" prefixOverrides="AND|OR">
			<if test="kpiCode!=null and kpiCode!=''">
				AND kpi_code like "%"#{kpiCode,jdbcType=VARCHAR}"%"
			</if>
			<if test="kpiName!=null and kpiName!=''">
				AND kpi_name like "%"#{kpiName}"%"
			</if>
			<if test="dispName!=null and dispName!=''">
				AND disp_name like "%"#{dispName}"%"
			</if>
			<if test="kpiType!=null and kpiType!=''">
				AND kpi_type=#{kpiType}
			</if>
			<if test="isOverall!=null and isOverall!=''">
				AND is_overall=#{isOverall}
			</if>
			<!-- 是否显示 -->
			<if test="isShow!=null and isShow!=''">
				AND is_show=#{isShow}
			</if>
			<!-- 是否可用 -->
			<if test="isUse!=null and isUse!=''">
				AND is_use=#{isUse}
			</if>
			<!-- 是否计算规则 -->
			<if test="isCalKpi!=null and isCalKpi!=''">
				AND is_cal_kpi=#{isCalKpi}
			</if>
		</trim>
		ORDER BY show_order
	</select>
	<!-- 根据产品ID，通用指标，指标类型（日，周，月）查询指标信息 -->
	<select id="queryOneByCommonKpiAndKpiTypeIdAndProductId"
		resultMap="DwpasCKpiInfoResultMap" parameterType="java.util.HashMap">
		<!-- 一个通用指标对应着多个指标,一个指标只属于一个通用指标;#一个产品对应着多个指标 -->
		select ki.kpi_code, ki.parent_code, ki.kpi_name, ki.disp_name,
		ki.kpi_type, ki.is_overall, ki.is_show, ki.show_order,
		ki.is_average,
		ki.is_max, ki.is_variation, ki.is_percent,
		ki.unit, ki.decimal_num,
		ki.convert_num, ki.convert_type,
		ki.is_cal_kpi, ki.role_formula,
		ki.is_use, ki.gmt_create,
		ki.gmt_modified from dwpas_c_kpi_info ki,
		dwpas_r_kpi_comkpi kc,
		dwpas_r_prd_kpi pk where pk.product_id
		=#{productId,jdbcType=VARCHAR} and ki.kpi_type =
		#{kpiType,jdbcType=VARCHAR} and ki.is_use = '1' and
		kc.com_kpi_code
		=#{commonKpiCode,jdbcType=VARCHAR} and
		ki.kpi_code = kc.kpi_code and
		ki.kpi_code = pk.kpi_code order by
		ki.show_order asc
	</select>
	<!-- zy三表关联 -->
	<!-- <select id="qryAllByComKpiCodeAndPrdIds" resultMap="DwpasCKpiInfoResultMap"
		parameterType="java.util.HashMap" resultType="java.util.HashMap">
		select
		ki.kpi_code, pk.product_id, ki.parent_code, ki.kpi_name,
		ki.disp_name,
		ki.kpi_type, ki.is_overall, ki.is_show, ki.show_order,
		ki.is_average,
		ki.is_max, ki.is_variation, ki.is_percent, ki.unit,
		ki.decimal_num,
		ki.convert_num, ki.convert_type,
		ki.is_cal_kpi,
		ki.role_formula, ki.is_use, ki.gmt_create, ki.gmt_modified
		from
		dwpas_c_kpi_info ki, dwpas_r_kpi_comkpi kc, dwpas_r_prd_kpi pk
		where
		kc.com_kpi_code=#{comKpiCode,jdbcType=VARCHAR}
		and
		ki.kpi_type=#{kpiType,jdbcType=VARCHAR} and ki.is_use='1'
		and
		pk.product_id in
		<foreach collection="productIds" item="productId" open="("
			close=")" separator=",">
			#{productId,jdbcType=VARCHAR}
		</foreach>
		and ki.kpi_code=kc.kpi_code
		and ki.kpi_code=pk.kpi_code
		order by
		ki.show_order asc
	</select> -->
	<!-- 根据通用指标和指标类型得到大盘指标 -->
	<select id="queryOverallKpiCodeByCommonKpiCodeAndKpiType"
		resultMap="DwpasCKpiInfoResultMap" parameterType="java.util.HashMap">
		select ki.kpi_code,
		ki.parent_code,
		ki.kpi_name,
		ki.disp_name,
		ki.kpi_type,
		ki.is_overall,
		ki.is_show,
		ki.show_order,
		ki.is_average,
		ki.is_max,
		ki.is_variation,
		ki.is_percent,
		ki.unit,
		ki.decimal_num,
		ki.convert_num,
		ki.convert_type,
		ki.is_cal_kpi,
		ki.role_formula,
		ki.is_use,
		ki.gmt_create,
		ki.gmt_modified
		from dwpas_c_kpi_info ki, dwpas_r_kpi_comkpi kc
		where ki.kpi_type =
		#{kpiType,jdbcType=VARCHAR}
		and ki.is_use = '1'
		and ki.is_overall = '1'
		and kc.com_kpi_code = #{commonKpiCode,jdbcType=VARCHAR}
		and ki.kpi_code
		= kc.kpi_code
		order by ki.show_order asc
	</select>
	<!-- 根据产品ID，多个通用指标，指标类型（日，周，月）查询指标信息 -->
	<select id="queryMultiByMultiCommonKpiAndKpiTypeIdAndProductId"
		resultMap="DwpasCKpiInfoResultMap" parameterType="java.util.HashMap">
		<!-- 一个通用指标对应着多个指标,一个指标只属于一个通用指标;#一个产品对应着多个指标 -->
		select ki.kpi_code, ki.parent_code, ki.kpi_name, ki.disp_name,
		ki.kpi_type, ki.is_overall, ki.is_show, ki.show_order,
		ki.is_average,
		ki.is_max, ki.is_variation, ki.is_percent,
		ki.unit, ki.decimal_num,
		ki.convert_num, ki.convert_type,
		ki.is_cal_kpi, ki.role_formula,
		ki.is_use, ki.gmt_create,
		ki.gmt_modified from dwpas_c_kpi_info ki,
		dwpas_r_kpi_comkpi kc,
		dwpas_r_prd_kpi pk where ki.kpi_code =
		kc.kpi_code and
		ki.kpi_code = pk.kpi_code and
		pk.product_id=#{productId,jdbcType=VARCHAR} and ki.kpi_type
		=#{kpiType,jdbcType=VARCHAR} and ki.is_use = '1'  and ki.is_show = '1'  and
		kc.com_kpi_code IN
		<foreach collection="commonKpiCodes" item="commonKpiCode"
			open="(" close=")" separator=",">
			#{commonKpiCode,jdbcType=VARCHAR}
		</foreach>
		order by ki.show_order asc
	</select>

	<!-- 查询指标分析中的大盘指标 -->
	<select id="getAllOverallKpis" resultMap="DwpasCKpiInfoResultMap"
		parameterType="java.util.HashMap">
		select kpi_code, parent_code, kpi_name, disp_name,
		kpi_type, is_overall, is_show, show_order,
		is_average,
		is_max,
		is_variation, is_percent,
		unit, decimal_num,
		convert_num, convert_type,
		is_cal_kpi, role_formula,
		is_use, gmt_create
		from dwpas_c_kpi_info
		where
		kpi_type=#{kpiType,jdbcType=VARCHAR}
		and
		is_overall=#{isOverall,jdbcType=VARCHAR}
		and
		is_show=#{isShow,jdbcType=VARCHAR}
		and is_use=#{isUse,jdbcType=VARCHAR}
	</select>


	<!-- mapped statement for IbatisDwpasCKpiInfoDAO.qryAllByKpiCodes -->
	<select id="qryAllByKpiCodes" resultMap="DwpasCKpiInfoResultMap">
		select kpi_code, parent_code, kpi_name, disp_name, kpi_type,
		is_overall, is_show, show_order, is_average, is_max, is_variation,
		is_percent, unit, decimal_num, convert_num, convert_type, is_cal_kpi,
		role_formula, is_use, gmt_create, gmt_modified from dwpas_c_kpi_info
		where kpi_code in
		<!-- <iterate open="(" close=")" conjunction=","> -->
		<!-- #[]# -->
		<!-- </iterate> -->

		<foreach collection="code" item="code" open="(" close=")"
			separator=",">
			#{code}
		</foreach>
		and is_use='1' order by show_order asc
	</select>

	<!-- 根据typeIds查询指标小类 -->
	<select id="getChildCodeByTypeIds" resultMap="DwpasCKpiInfoResultMap"
		parameterType="java.util.HashMap">
		select
		ki.kpi_code,ki.parent_code,ki.kpi_name,ki.disp_name,ki.kpi_type,ki.is_overall,ki.is_show,ki.show_order,ki.is_average,
		ki.is_max,ki.is_variation,ki.is_percent,ki.unit,ki.decimal_num,ki.convert_num,ki.convert_type,ki.is_cal_kpi,ki.role_formula,ki.is_use,
		ki.gmt_create,ki.gmt_modified,dt.type_name
		FROM
		dwpas_c_kpi_info
		ki,dwpas_r_prd_kpi pk,dwpas_c_sys_type dt
		<trim prefix="WHERE" prefixOverrides="AND|OR">
			<if test="typeIds!=null">
				AND ki.parent_code in
				<foreach collection="typeIds" open="(" separator="," close=")"
					item="parentCode">
					#{parentCode}
				</foreach>
			</if>
			<if test="productId!=null and productId!=''">
				AND pk.product_id=#{productId}
			</if>
			<if test="kpiType!=null and kpiType!=''">
				AND ki.kpi_type=#{kpiType}
			</if>
			<if test="risOverall!=null and isOverall!=''">
				AND ki.is_overall=#{isOverall}
			</if>
			AND ki.is_show = '1'
			AND ki.is_use = '1'
			AND
			ki.kpi_code = pk.kpi_code
			and dt.type_id= ki.parent_code
		</trim>
		ORDER BY
		instr(#{typeIdStr},concat(',',ki.parent_code,',')),ki.kpi_code
	</select>

	<select id="qryOneByPrdIdAndComKpiCode" resultMap="DwpasCKpiInfoResultMap">
		select
		ki.kpi_code, pk.product_id, ki.parent_code, ki.kpi_name,
		ki.disp_name,
		ki.kpi_type, ki.is_overall, ki.is_show, ki.show_order,
		ki.is_average,
		ki.is_max, ki.is_variation, ki.is_percent, ki.unit,
		ki.decimal_num,
		ki.convert_num, ki.convert_type,
		ki.is_cal_kpi,
		ki.role_formula,
		ki.is_use, ki.gmt_create, ki.gmt_modified
		from
		dwpas_c_kpi_info ki,
		dwpas_r_kpi_comkpi kc, dwpas_r_prd_kpi pk
		where
		kc.com_kpi_code=#{comKpiCode,jdbcType=VARCHAR}
		and
		ki.kpi_type=#{kpiType,jdbcType=VARCHAR} and ki.is_use='1'
		and
		pk.product_id =#{productId,jdbcType=VARCHAR}
		and
		ki.kpi_code=kc.kpi_code
		and ki.kpi_code=pk.kpi_code
		order by
		ki.show_order asc
	</select>
	<!-- 获得指标信息 -->
	<select id="getDwpasCKpiInfo" resultMap="DwpasCKpiInfoResultMap"
		parameterType="java.util.HashMap">
		select ki.kpi_code, ki.parent_code, ki.kpi_name,
		ki.disp_name, ki.kpi_type,
		ki.is_overall, ki.is_show, ki.show_order,
		ki.is_average,
		ki.is_max, ki.is_variation, ki.is_percent, ki.unit,
		ki.decimal_num,
		ki.convert_num, ki.convert_type,
		ki.is_cal_kpi,
		ki.role_formula, ki.is_use, ki.gmt_create, ki.gmt_modified
		from
		dwpas_c_kpi_info ki, dwpas_r_kpi_comkpi kc, dwpas_r_prd_kpi pk
		where
		pk.product_id=#{productId}
		and ki.kpi_type=#{kpiType} and ki.is_use='1'
		and kc.com_kpi_code=#{comKpiCode}
		and ki.kpi_code=kc.kpi_code
		and
		ki.kpi_code=pk.kpi_code
		order by ki.show_order asc
	</select>

	<!-- 通用指标对应的指标信息 -->
	<select id="getDwpasCKpiInfoByKpiCode" resultMap="DwpasCKpiInfoResultMap"
		parameterType="java.lang.String">
    <![CDATA[
        select kpi_code, parent_code, kpi_name, disp_name, kpi_type, is_overall, is_show, show_order, is_average, is_max, is_variation, is_percent, unit, decimal_num, convert_num, convert_type, is_cal_kpi, role_formula, is_use, gmt_create, gmt_modified from dwpas_c_kpi_info where (kpi_code = #{value})
    ]]>
	</select>

</mapper>