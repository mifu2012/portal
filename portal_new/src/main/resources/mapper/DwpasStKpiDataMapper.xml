<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.infosmart.mapper.DwpasStKpiDataMapper">
    <!-- 默认加上缓存 -->
    <cache readOnly="true"/>
    
	<sql id="common_sql">
		kpi_id,kpi_code,report_date,base_value,
		age_value,trend_value,
		per_value,max_value, min_value, value1, value2,
		value3,
		sort_cnt, date_type, gmt_max_time, gmt_create
	</sql>
	<!-- 指标数据记录集 -->
	<resultMap id="DwpasStKpiDataResultMap" type="DwpasStKpiData">
		<!-- WARNING - This element is automatically generated by Apache iBATIS 
			ibator, do not modify. This element was generated on Mon Feb 20 17:55:25 
			CST 2012. -->
		<result column="KPI_ID" property="kpiId" jdbcType="DECIMAL" />
		<result column="KPI_CODE" property="kpiCode" jdbcType="VARCHAR" />
		<result column="REPORT_DATE" property="reportDate" jdbcType="VARCHAR" />
		<result column="BASE_VALUE" property="baseValue" jdbcType="DECIMAL" />
		<result column="AGE_VALUE" property="ageValue" jdbcType="DECIMAL" />
		<result column="TREND_VALUE" property="trendValue" jdbcType="DECIMAL" />
		<result column="PER_VALUE" property="perValue" jdbcType="DECIMAL" />
		<result column="MAX_VALUE" property="maxValue" jdbcType="DECIMAL" />
		<result column="MIN_VALUE" property="minValue" jdbcType="DECIMAL" />
		<result column="VALUE1" property="value1" jdbcType="DECIMAL" />
		<result column="VALUE2" property="value2" jdbcType="DECIMAL" />
		<result column="VALUE3" property="value3" jdbcType="DECIMAL" />
		<result column="SORT_CNT" property="sortCnt" jdbcType="DECIMAL" />
		<result column="DATE_TYPE" property="dateType" jdbcType="CHAR" />
		<result column="GMT_MAX_TIME" property="gmtMaxTime" jdbcType="VARCHAR" />
		<result column="GMT_CREATE" property="gmtCreate" jdbcType="TIMESTAMP" />
		<result column="GMT_MODIFIED" property="gmtModified" jdbcType="TIMESTAMP" />
	</resultMap>
	<!-- 指标数据与指标信息记录集 -->
	<resultMap id="DwpasStKpiDataAndKpiInfoResultMap" type="DwpasStKpiData">
		<!-- WARNING - This element is automatically generated by Apache iBATIS 
			ibator, do not modify. This element was generated on Mon Feb 20 17:55:25 
			CST 2012. -->
		<result column="KPI_ID" property="kpiId" jdbcType="DECIMAL" />
		<result column="KPI_CODE" property="kpiCode" jdbcType="VARCHAR" />
		<result column="REPORT_DATE" property="reportDate" jdbcType="VARCHAR" />
		<result column="BASE_VALUE" property="baseValue" jdbcType="DECIMAL" />
		<result column="AGE_VALUE" property="ageValue" jdbcType="DECIMAL" />
		<result column="TREND_VALUE" property="trendValue" jdbcType="DECIMAL" />
		<result column="PER_VALUE" property="perValue" jdbcType="DECIMAL" />
		<result column="MAX_VALUE" property="maxValue" jdbcType="DECIMAL" />
		<result column="MIN_VALUE" property="minValue" jdbcType="DECIMAL" />
		<result column="VALUE1" property="value1" jdbcType="DECIMAL" />
		<result column="VALUE2" property="value2" jdbcType="DECIMAL" />
		<result column="VALUE3" property="value3" jdbcType="DECIMAL" />
		<result column="SORT_CNT" property="sortCnt" jdbcType="DECIMAL" />
		<result column="DATE_TYPE" property="dateType" jdbcType="CHAR" />
		<result column="GMT_MAX_TIME" property="gmtMaxTime" jdbcType="VARCHAR" />
		<result column="GMT_CREATE" property="gmtCreate" jdbcType="TIMESTAMP" />
		<!-- 数据为 0000-00-00 00:00:00 会报错，暂时去掉 -->
		<!-- <result column="GMT_MODIFIED" property="gmtModified" jdbcType="TIMESTAMP" 
			javaType="java.util.Date" /> -->
		<!-- 一对一 -->
		<association property="dwpasCKpiInfo" column="kpi_code"
			javaType="DwpasCKpiInfo"
			resultMap="com.infosmart.mapper.DwpasCKpiInfoMapper.DwpasCKpiInfoResultMap">
		</association>
	</resultMap>

	<!-- 用户体验数据信息 -->
	<resultMap id="UserExperienceDataResultMap" type="UserExperienceDataInfo">
		<!-- WARNING - This element is automatically generated by Apache iBATIS 
			ibator, do not modify. This element was generated on Mon Feb 20 17:55:25 
			CST 2012. -->
		<result column="COLUMN_CODE" property="columnCode" jdbcType="VARCHAR" />
		<result column="KPI_CODE" property="kpiCode" jdbcType="VARCHAR" />
		<result column="COM_CODE" property="comeCode" jdbcType="VARCHAR" />
		<result column="BASE_VALUE" property="baseValue" jdbcType="DECIMAL" />
	</resultMap>
	<!-- 根据指标编码统计指标数据 -->
	<select id="statKpiDataAndKpiInfoBetweenDateByMultiKpi"
		resultMap="DwpasStKpiDataAndKpiInfoResultMap" parameterType="java.util.HashMap">
		SELECT skd.kpi_code, sum(IFNULL(skd.base_value, 0)) as base_value
		FROM
		dwpas_st_kpi_data skd
		<trim prefix="WHERE" prefixOverrides="AND|OR">
			<!-- 多个指标查询 -->
			<if test="kpiCodes!=null">
				AND skd.kpi_code in
				<foreach collection="kpiCodes" close=")" separator="," open="("
					item="kpiCode">
					#{kpiCode}
			    </foreach>
			</if>
			<if test="dateType!=null and dateType!=''">
				AND skd.DATE_TYPE=#{dateType}
			</if>
			<!-- 开始日期 -->
			<if test="reportBeginDate!=null and reportBeginDate!=''">
				AND skd.REPORT_DATE &gt;=#{reportBeginDate}
			</if>
			<!-- 结束日期 -->
			<if test="reportEndDate!=null and reportEndDate!=''">
				AND skd.REPORT_DATE &lt;=#{reportEndDate}
			</if>
		</trim>
		group BY skd.KPI_CODE
	</select>
	<!-- 根据KPI编码,查询类型参数和KPI数据时间范围查询KPI数据 -->
	<select id="queryKpiDataAndKpiInfoBetweenDate" resultMap="DwpasStKpiDataAndKpiInfoResultMap"
		parameterType="java.util.HashMap">
		SELECT skd.kpi_id,skd.kpi_code,skd.report_date,skd.base_value,
		skd.age_value,skd.trend_value, skd.per_value,skd.max_value,
		skd.min_value, skd.value1, skd.value2, skd.value3, skd.sort_cnt,
		skd.date_type, skd.gmt_max_time,
		cki.parent_code,cki.kpi_name,cki.disp_name,cki.kpi_type,cki.is_overall,cki.is_show,cki.show_order,cki.is_average,cki.is_max,cki.is_variation,cki.is_percent,cki.unit,cki.decimal_num,cki.convert_num,cki.convert_type,cki.is_cal_kpi,cki.role_formula,cki.is_use
		FROM dwpas_st_kpi_data skd LEFT JOIN dwpas_c_kpi_info cki ON
		skd.KPI_CODE = cki.KPI_CODE
		<trim prefix="WHERE" prefixOverrides="AND|OR">
			<if test="kpiCode!=null and kpiCode!=''">
				AND skd.kpi_code=#{kpiCode}
			</if>
			<if test="dateType!=null and dateType!=''">
				AND skd.DATE_TYPE=#{dateType}
			</if>
			<!-- 开始日期 -->
			<if test="reportBeginDate!=null and reportBeginDate!=''">
				AND skd.REPORT_DATE &gt;=#{reportBeginDate}
			</if>
			<!-- 结束日期 -->
			<if test="reportEndDate!=null and reportEndDate!=''">
				AND skd.REPORT_DATE &lt;=#{reportEndDate}
			</if>
		</trim>
		ORDER BY report_date
	</select>
	<!-- 根据KPI编码,查询类型参数和KPI数据时间范围查询KPI数据 -->
	<select id="queryKpiDataAndKpiInfoBetweenDateByMultiKpi"
		resultMap="DwpasStKpiDataAndKpiInfoResultMap" parameterType="java.util.HashMap">
		SELECT skd.kpi_id,skd.kpi_code,skd.report_date,skd.base_value,
		skd.age_value,skd.trend_value, skd.per_value,skd.max_value,
		skd.min_value, skd.value1, skd.value2, skd.value3, skd.sort_cnt,
		skd.date_type, skd.gmt_max_time,
		cki.parent_code,cki.kpi_name,IF(ISNULL(cki.disp_name),cki.kpi_name,cki.disp_name) as disp_name,cki.kpi_type,cki.is_overall,cki.is_show,cki.show_order,cki.is_average,cki.is_max,cki.is_variation,cki.is_percent,cki.unit,cki.decimal_num,cki.convert_num,cki.convert_type,cki.is_cal_kpi,cki.role_formula,cki.is_use
		FROM dwpas_st_kpi_data skd LEFT JOIN dwpas_c_kpi_info cki ON
		skd.KPI_CODE = cki.KPI_CODE
		<trim prefix="WHERE" prefixOverrides="AND|OR">
			<!-- 多个指标查询 -->
			<if test="kpiCodes!=null">
				AND skd.kpi_code in
				<foreach collection="kpiCodes" close=")" separator="," open="("
					item="kpiCode">
					#{kpiCode}
			    </foreach>
			</if>
			<if test="dateType!=null and dateType!=''">
				AND skd.DATE_TYPE=#{dateType}
			</if>
			<!-- 开始日期 -->
			<if test="reportBeginDate!=null and reportBeginDate!=''">
				AND skd.REPORT_DATE &gt;=#{reportBeginDate}
			</if>
			<!-- 结束日期 -->
			<if test="reportEndDate!=null and reportEndDate!=''">
				AND skd.REPORT_DATE &lt;=#{reportEndDate}
			</if>
		</trim>
		ORDER BY skd.KPI_CODE, report_date
	</select>
	<!-- 根据KPI指标编码查询KPI数据及相应指标信息 -->
	<select id="queryKpiDataAndKpiInfoByKpiCodes" resultMap="DwpasStKpiDataAndKpiInfoResultMap"
		parameterType="java.util.HashMap">
		SELECT skd.kpi_id,skd.kpi_code,skd.report_date,skd.base_value,
		skd.age_value,skd.trend_value, skd.per_value,skd.max_value,
		skd.min_value, skd.value1, skd.value2, skd.value3, skd.sort_cnt,
		skd.date_type, skd.gmt_max_time,
		cki.parent_code,cki.kpi_name,cki.disp_name,cki.kpi_type,cki.is_overall,cki.is_show,cki.show_order,cki.is_average,cki.is_max,cki.is_variation,cki.is_percent,cki.unit,cki.decimal_num,cki.convert_num,cki.convert_type,cki.is_cal_kpi,cki.role_formula,cki.is_use
		FROM dwpas_st_kpi_data skd LEFT JOIN dwpas_c_kpi_info cki ON
		skd.KPI_CODE = cki.KPI_CODE
		<trim prefix="WHERE" prefixOverrides="AND|OR">
			<if test="kpiCodes!=null">
				AND skd.kpi_code in
				<foreach collection="kpiCodes" separator="," close=")" open="("
					item="kpiCode">
					#{kpiCode}
				</foreach>
			</if>
			<if test="reportDate!=null and reportDate!=''">
				AND skd.REPORT_DATE=#{reportDate}
			</if>
			<if test="dateType!=null and dateType!=''">
				AND skd.DATE_TYPE=#{dateType}
			</if>
		</trim>
		ORDER BY kpi_code
	</select>
	<!-- 查询指标数据及指标信息 -->
	<select id="queryKpiDataAndKpiInfoByCondition" resultMap="DwpasStKpiDataAndKpiInfoResultMap"
		parameterType="java.util.HashMap">
		SELECT skd.kpi_id,skd.kpi_code,skd.report_date,skd.base_value,
		skd.age_value,skd.trend_value, skd.per_value,skd.max_value,
		skd.min_value, skd.value1, skd.value2, skd.value3, skd.sort_cnt,
		skd.date_type, skd.gmt_max_time,
		cki.parent_code,cki.kpi_name,cki.disp_name,cki.kpi_type,cki.is_overall,cki.is_show,cki.show_order,cki.is_average,cki.is_max,cki.is_variation,cki.is_percent,cki.unit,cki.decimal_num,cki.convert_num,cki.convert_type,cki.is_cal_kpi,cki.role_formula,cki.is_use
		FROM dwpas_st_kpi_data skd LEFT JOIN dwpas_c_kpi_info cki ON
		skd.KPI_CODE = cki.KPI_CODE
		<trim prefix="WHERE" prefixOverrides="AND">
			<if test="kpiCode!=null and kpiCode!=''">
				AND skd.kpi_code=#{kpiCode}
			</if>
			<if test="dateType!=null and dateType!=''">
				AND skd.DATE_TYPE=#{dateType}
			</if>
			<if test="reportDate!=null and reportDate!=''">
				AND skd.REPORT_DATE=#{reportDate}
			</if>
		</trim>
	</select>

	<select id="qryOneByKpiCodeAndDate" resultMap="DwpasStKpiDataResultMap">
    <![CDATA[
        select  kpi_id, kpi_code, report_date, base_value, age_value, trend_value, per_value, max_value, min_value, value1, value2, value3, sort_cnt, date_type, gmt_max_time, gmt_create, gmt_modified from dwpas_st_kpi_data where ((report_date = #{reportDate}) AND (kpi_code = #{kpiCode}))
     ]]>
	</select>
	<!-- 获取指标数据 -->
	<select id="getDwpasStKpiData" resultMap="DwpasStKpiDataResultMap">
    <![CDATA[
        select kpi_id, kpi_code, report_date, base_value, age_value, trend_value, per_value, max_value, min_value, value1, value2, value3, sort_cnt, date_type, gmt_max_time, gmt_create, gmt_modified from dwpas_st_kpi_data where ((report_date = #{reportDate}) AND (kpi_code = #{kpiCode}))
    ]]>
	</select>
	<!-- 获取指标数据集 -->
	<select id="getDwpasStKpiDataList" resultMap="DwpasStKpiDataResultMap">
		select kpi_id, kpi_code, report_date, base_value, age_value,
		trend_value, per_value, max_value, min_value, value1, value2, value3,
		sort_cnt, date_type, gmt_max_time, gmt_create, gmt_modified from
		dwpas_st_kpi_data
		where kpi_code=#kpiCode#
		<if test="gmtStartDate!=null and gmtStartDate!=''">
			AND report_date &gt;= #{gmtStartDate,jdbcType=VARCHAR}"
		</if>
		<if test="gmtEndDate!=null and gmtEndDate!=''">
			AND report_date &gt;= #{gmtEndDate,jdbcType=VARCHAR}"
		</if>
		order by report_date asc
	</select>

	<!-- 根据KPI指标编码及相应信息查询KPI数据 -->
	<select id="listDwpasStKpiDataByCodeList" resultMap="DwpasStKpiDataAndKpiInfoResultMap"
		parameterType="java.util.HashMap">
		SELECT skd.kpi_id,skd.kpi_code,skd.report_date,skd.base_value,
		skd.age_value,skd.trend_value, skd.per_value,skd.max_value,
		skd.min_value, skd.value1, skd.value2, skd.value3, skd.sort_cnt,
		skd.date_type, skd.gmt_max_time,
		cki.parent_code,cki.kpi_name,cki.disp_name,cki.kpi_type,cki.is_overall,cki.is_show,cki.show_order,cki.is_average,cki.is_max,cki.is_variation,cki.is_percent,cki.unit,cki.decimal_num,cki.convert_num,cki.convert_type,cki.is_cal_kpi,cki.role_formula,cki.is_use
		FROM dwpas_st_kpi_data skd LEFT JOIN dwpas_c_kpi_info cki ON
		skd.KPI_CODE = cki.KPI_CODE
		<trim prefix="WHERE" prefixOverrides="AND|OR">
			<if test="codeList!=null">
				AND skd.kpi_code in
				<foreach collection="codeList" open="(" separator="," close=")"
					item="kpiCode">
					#{kpiCode}
				</foreach>
			</if>
			<if test="dateType!=null and dateType!=''">
				AND skd.DATE_TYPE=#{dateType}
			</if>
			<!-- 开始日期 -->
			<if test="reportBeginDate!=null and reportBeginDate!=''">
				AND skd.REPORT_DATE &gt;=#{reportBeginDate}
			</if>
			<!-- 结束日期 -->
			<if test="reportEndDate!=null and reportEndDate!=''">
				AND skd.REPORT_DATE &lt;=#{reportEndDate}
			</if>
		</trim>
		ORDER BY instr(#{codeStr},concat(',',skd.kpi_code,',')),report_date
	</select>


	<!-- 根据栏目编码list和产品ID列出指标信息 -->
	<select id="listKpiDataByColumnCodeListAndPrdId" parameterType="java.util.HashMap"
		resultMap="UserExperienceDataResultMap">
		select cki.kpi_code,cci.column_code, rcck.com_kpi_code,
		skd.base_value
		from DWPAS_R_KPI_COMKPI rkc,
		dwpas_r_prd_kpi rpk,
		dwpas_c_kpi_info cki, dwpas_r_column_com_kpi rcck, dwpas_st_kpi_data
		skd,dwpas_c_column_info cci
		<trim prefix="WHERE" prefixOverrides="AND|OR">
			<if test="columnCodeList!=null">
				AND cci.column_code in
				<foreach collection="columnCodeList" separator="," close=")"
					open="(" item="columnCode">
					#{columnCode}
				</foreach>
			</if>

		</trim>
		and rpk.KPI_CODE = rkc.KPI_CODE
		and rpk.product_id = #{productId}
		and
		cki.kpi_type=#{kpiType}
		and skd.report_date=#{reportDate}
		and
		skd.kpi_code=cki.kpi_code
		and cki.kpi_code =rkc.KPI_CODE
		and
		rkc.com_kpi_code = rcck.com_kpi_code
		and cci.column_id=rcck.column_id
		order by cki.show_order;
	</select>
</mapper>