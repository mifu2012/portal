<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.infosmart.mapper.DwpasStUserFeatureDsMapper">
	<!-- 用户特征数据 -->
	<resultMap id="DwpasStUserFeatureDsResultMap" type="DwpasStUserFeatureDs">
		<!-- WARNING - This element is automatically generated by Apache iBATIS 
			ibator, do not modify. This element was generated on Mon Feb 20 17:20:52 
			CST 2012. -->
		<result column="product_id" jdbcType="VARCHAR" property="productId" />
		<result column="report_date" jdbcType="VARCHAR" property="reportDate" />
		<result column="feature_type" jdbcType="VARCHAR" property="featureType" />
		<result column="feature_id" jdbcType="VARCHAR" property="featureId" />
		<result column="user_cnt" jdbcType="DECIMAL" property="userCnt" />
		<result column="user_rate" jdbcType="DECIMAL" property="userRate" />
		<result column="GMT_CREATE" jdbcType="TIMESTAMP" property="gmtCreate" />
		<!-- 数据为 0000-00-00 00:00:00 会报错，暂时去掉 -->
		<!-- <result column="GMT_MODIFIED" jdbcType="TIMESTAMP" property="gmtModified" 
			/> -->
	</resultMap>
	<!-- 查询某产品某时间的某特征数据结果集 -->
	<resultMap id="queryDataByPrdIdAndFeatureTypeAndReportDateResultMap"
		type="DwpasStUserFeatureDs">
		<!-- WARNING - This element is automatically generated by Apache iBATIS 
			ibator, do not modify. This element was generated on Mon Feb 20 17:20:52 
			CST 2012. -->
		<result column="product_id" jdbcType="VARCHAR" property="productId" />
		<result column="report_date" jdbcType="VARCHAR" property="reportDate" />
		<result column="feature_type" jdbcType="VARCHAR" property="featureType" />
		<result column="feature_id" jdbcType="VARCHAR" property="featureId" />
		<!-- 加了个冗余，特征名称 -->
		<result column="feature_name" jdbcType="VARCHAR" property="featureName" />
		<result column="user_cnt" jdbcType="DECIMAL" property="userCnt" />
		<result column="user_rate" jdbcType="DECIMAL" property="userRate" />
		<result column="GMT_CREATE" jdbcType="TIMESTAMP" property="gmtCreate" />
		<!-- 数据为 0000-00-00 00:00:00 会报错，暂时去掉 -->
		<!-- <result column="GMT_MODIFIED" jdbcType="TIMESTAMP" property="gmtModified" 
			/> -->
	</resultMap>
	<!-- 查询某产品某时间的某特征数据 -->
	<select id="queryDataByPrdIdAndFeatureTypeAndReportDate"
		parameterType="DwpasStUserFeatureDs" resultMap="queryDataByPrdIdAndFeatureTypeAndReportDateResultMap">
		select ds.product_id,
		ds.report_date, ds.feature_id,
		ds.feature_type, uf.feature_name,
		ds.user_cnt, ds.user_rate,
		ds.gmt_create, ds.gmt_modified from
		dwpas_st_user_feature_ms ds,
		dwpas_c_user_feature uf where
		ds.product_id =
		#{productId,jdbcType=VARCHAR} and ds.feature_type =
		#{featureType,jdbcType=VARCHAR} and ds.report_date =
		#{reportDate,jdbcType=VARCHAR} and ds.product_id = uf.product_id
		and
		ds.feature_id = uf.feature_id and ds.feature_type =
		uf.feature_type
		ORDER BY (ds.feature_id+0)
	</select>
	<select id="queryDwpasStUserFeatureByfeatureTypeAndproductIdAndReportDate"
		parameterType="java.util.HashMap" resultType="java.util.HashMap">
		select
		ds.product_id,
		ds.report_date, ds.feature_id, ds.feature_type,
		uf.feature_name,
		ds.user_cnt, ds.user_rate, ds.gmt_create,
		ds.gmt_modified
		from
		dwpas_st_user_feature_ms ds, dwpas_c_user_feature uf where
		ds.product_id=#{productId,jdbcType=VARCHAR} and
		ds.feature_type=#{featureType,jdbcType=VARCHAR} and
		ds.report_date=#{reportDate,jdbcType=VARCHAR}
		and
		ds.product_id=uf.product_id
		and ds.feature_id=uf.feature_id
		and
		ds.feature_type=uf.feature_type
	</select>
	<resultMap type="DwpasStUserFeatureDs" id="DwpasStUserFeatureAmmapData">
		<result column="product_id" property="productId" />
		<result column="report_date" property="reportDate" />
		<result column="feature_type" property="featureType" />
		<result column="feature_id" property="featureId" />
		<result column="feature_name" property="featureName" />
		<result column="ufPercent" property="ufPercent" />
		<result column="user_cnt" property="userCnt" />
		<result column="sales_valume" property="salesVolume" />
		<result column="ranking" property="ranking" />
	</resultMap>
	<select id="queryAmmapByPrdIdAndFeatureTypeAndReportDate"
		parameterType="DwpasStUserFeatureDs" resultMap="DwpasStUserFeatureAmmapData">
		SELECT
		@rownum :=@rownum
		+ 1 AS ranking,
		a.feature_id,
		a.feature_type,
		a.feature_name,
		a.product_id,
		IFNULL(a.user_cnt, 0)AS user_cnt,
		IFNULL(a.ufPercent,
		'0%')AS ufPercent,
		IFNULL(a.sales_valume,
		0)sales_valume
		FROM
		(SELECT
		@rownum := 0)r,
		(
		SELECT
		uf.feature_id,
		uf.feature_type,
		uf.feature_name,
		uf.product_id,
		ds.report_date,
		ds.user_cnt,
		CONCAT(
		round(ds.user_rate *
		100, 2),
		'%'
		)AS ufPercent,
		ds.sales_valume
		FROM
		(
		SELECT
		*
		FROM
		dwpas_c_user_feature uf
		WHERE
		uf.FEATURE_TYPE =
		#{featureType,jdbcType=VARCHAR}
		AND uf.PRODUCT_ID =
		#{productId,jdbcType=VARCHAR}
		)uf
		LEFT JOIN dwpas_st_user_feature_ms ds
		ON uf.FEATURE_ID = ds.FEATURE_ID
		AND ds.product_id = uf.product_id
		AND
		uf.FEATURE_TYPE = ds.FEATURE_TYPE
		AND ds.report_date =
		#{reportDate,jdbcType=VARCHAR}
		ORDER BY
		ds.user_cnt DESC
		)a
	</select>
</mapper>