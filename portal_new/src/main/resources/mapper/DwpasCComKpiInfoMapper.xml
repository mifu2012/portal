<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.infosmart.mapper.DwpasCComKpiInfoMapper">
    <!-- 默认加上缓存 -->
    <!--
    <cache readOnly="true"/>
    -->
    
	<!-- 通用指标信息记录集 -->
	<resultMap id="commKpiInfoResultMap" type="DwpasCComKpiInfo">
		<!-- WARNING - This element is automatically generated by Apache iBATIS 
			ibator, do not modify. This element was generated on Mon Feb 20 17:20:52 
			CST 2012. -->
		<result property="comKpiCode" column="COM_KPI_CODE" javaType="java.lang.String"
			jdbcType="VARCHAR" />
		<result property="comKpiName" column="COM_KPI_NAME" javaType="java.lang.String"
			jdbcType="VARCHAR" />
		<result property="isShowRank" column="IS_SHOW_RANK" javaType="java.lang.String"
			jdbcType="CHAR" />
		<result property="rankShowOrder" column="RANK_SHOW_ORDER"
			javaType="int" jdbcType="NUMERIC" />
		<result property="gmtCreate" column="GMT_CREATE" javaType="java.util.Date"
			jdbcType="TIMESTAMP" />
		<!-- 数据为 0000-00-00 00:00:00 会报错，暂时去掉 -->
		<result column="GMT_MODIFIED" property="gmtModified" jdbcType="TIMESTAMP"
			javaType="java.util.Date" />
	</resultMap>
	<!--通用指标及关联的指标列表记录集 -->
	<resultMap id="commKpiAndKpiInfoResultMap" type="DwpasCComKpiInfo">
		<!-- WARNING - This element is automatically generated by Apache iBATIS 
			ibator, do not modify. This element was generated on Mon Feb 20 17:20:52 
			CST 2012. -->
		<result property="comKpiCode" column="COM_KPI_CODE" javaType="java.lang.String"
			jdbcType="VARCHAR" />
		<result property="comKpiName" column="COM_KPI_NAME" javaType="java.lang.String"
			jdbcType="VARCHAR" />
		<result property="isShowRank" column="IS_SHOW_RANK" javaType="java.lang.String"
			jdbcType="CHAR" />
		<result property="rankShowOrder" column="RANK_SHOW_ORDER"
			javaType="int" jdbcType="NUMERIC" />
		<result property="gmtCreate" column="GMT_CREATE" javaType="java.util.Date"
			jdbcType="TIMESTAMP" />
		<!-- 通用指标关联的指标列表 -->
		<collection property="kpiInfoList"
			resultMap="com.infosmart.mapper.DwpasCKpiInfoMapper.DwpasCKpiInfoResultMap"
			javaType="java.util.ArrayList" column="kpi_code" />
	</resultMap>
	<!-- 根据查询条件查询通用指标信息 -->
	<select id="listCommonKpiCode" parameterType="DwpasCComKpiInfo"
		resultMap="commKpiInfoResultMap">
		select
		com_kpi_code,com_kpi_name,is_show_rank,rank_show_order,GMT_CREATE
		from
		dwpas_c_com_kpi_info
		<trim prefix="WHERE" prefixOverrides="AND|OR">
			<if test="comKpiCode!=null and comKpiCode!=''">
				AND COM_KPI_CODE=#{comKpiCode}
			</if>
			<if test="isShowRank!=null and isShowRank!=''">
				AND IS_SHOW_RANK=#{isShowRank}
			</if>
		</trim>
		<!-- 排序 -->
		ORDER BY rank_show_order
	</select>
	<!-- 分页列列出通用指标 -->
	<select id="listCommonKpiCodeByPagination" parameterType="DwpasCComKpiInfo"
		resultMap="commKpiInfoResultMap">
		select
		com_kpi_code,com_kpi_name,is_show_rank,rank_show_order,GMT_CREATE
		from
		dwpas_c_com_kpi_info
		<trim prefix="WHERE" prefixOverrides="AND|OR">
			<if test="comKpiCode!=null and comKpiCode!=''">
				AND COM_KPI_CODE like "%"#{comKpiCode}"%"
			</if>
			<if test="comKpiName!=null and comKpiName!=''">
				AND COM_KPI_NAME like "%"#{comKpiName}"%"
			</if>
			<if test="isShowRank!=null and isShowRank!=''">
				AND IS_SHOW_RANK=#{isShowRank}
			</if>
		</trim>
		<!-- 排序 -->
		ORDER BY rank_show_order
	</select>
	<!-- 列出某通用指标下所有指标信息 -->
	<select id="listKpiInfoByCommonKpiCode"
		resultMap="com.infosmart.mapper.DwpasCKpiInfoMapper.DwpasCKpiInfoResultMap"
		parameterType="string">
		select cki.kpi_code, parent_code, kpi_name, disp_name,
		kpi_type,
		is_overall, is_show, show_order, is_average, is_max,
		is_variation, is_percent, unit, decimal_num, convert_num,
		convert_type, is_cal_kpi, role_formula, is_use,cki.gmt_create
		from
		dwpas_c_kpi_info cki, dwpas_r_kpi_comkpi rkc where
		cki.KPI_CODE =
		rkc.kpi_code and rkc.com_kpi_code =
		#{commKpiCode,jdbcType=VARCHAR}
		ORDER BY cki.show_order
	</select>

	<!-- 通过条件查询KPIINFO hgt -->
	<select id="QUERY_KPI_INFO" resultMap="commKpiInfoResultMap"
		parameterType="DwpasCComKpiInfo">
		select com_kpi_code, com_kpi_name, is_show_rank, rank_show_order,
		gmt_create, gmt_modified
		from dwpas_c_com_kpi_info
		<trim prefix="WHERE" prefixOverrides="AND|OR">
			<if test="comKpiCode!=null and comKpiCode!=''">
				com_kpi_code=#{comKpiCode}
			</if>
			<if test="comKpiName!=null and comKpiName!=''">
				com_kpi_name=#{comKpiName}
			</if>
			<if test="isShowRank!=null and isShowRank!=''">
				is_show_rank=#{isShowRank}
			</if>
		</trim>
		order by rank_show_order asc
	</select>
	<!-- 根据产品ID，通用指标(多个)，指标类型（日，周，月）查询指标信息 -->
	<select id="listComCodeAndKpiInfoByMultiCommonKpiAndKpiTypeAndProdId"
		resultMap="commKpiAndKpiInfoResultMap" parameterType="java.util.HashMap">
		<!-- 一个通用指标对应着多个指标,一个指标只属于一个通用指标;#一个产品对应着多个指标 -->
		SELECT
		cci.com_kpi_code,
		cci.com_kpi_name,
		cki.kpi_code,
		cki.kpi_name,
		cki.parent_code,
		disp_name,
		kpi_type,
		is_overall,
		is_show,
		show_order,
		is_average,
		is_max,
		is_variation,
		is_percent,
		unit,
		decimal_num,
		convert_num,
		convert_type,
		is_cal_kpi,
		role_formula,
		is_use
		FROM
		dwpas_c_com_kpi_info cci,
		dwpas_r_kpi_comkpi rkc,
		dwpas_c_kpi_info cki,
		dwpas_r_prd_kpi rpk
		WHERE
		cci.com_kpi_code = rkc.com_kpi_code
		AND
		rkc.kpi_code = cki.kpi_code
		AND cki.kpi_code = rpk.kpi_code
		AND
		rpk.product_id =#{productId,jdbcType=VARCHAR}
		<if test="commKpiCodes!=null">
			AND cci.com_kpi_code IN
			<foreach collection="commKpiCodes" item="commonKpiCode" open="("
				close=")" separator=",">
				#{commonKpiCode,jdbcType=VARCHAR}
			</foreach>
		</if>
		AND cki.kpi_type = #{kpiType,jdbcType=VARCHAR}
		ORDER BY
		cki.show_order
	</select>
</mapper>